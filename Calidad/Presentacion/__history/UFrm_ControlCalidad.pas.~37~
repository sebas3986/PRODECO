unit UFrm_ControlCalidad;

interface

uses
  Winapi.Windows, System.SysUtils, System.IOUtils,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, Vcl.StdCtrls, Vcl.ComCtrls,
  Vcl.Buttons, Vcl.DBCtrls, Vcl.ValEdit, Vcl.Graphics,
  IdIPWatch, EnImgScr, RxCtrls,
  UDAOControlCalidad, UFTP, UCliente, UFrm_Testigo, UGlobales, UFrm_Identificacion,
  FPGenerales, UDMConexion, UDMAplicacion, Vcl.Mask, Vcl.Grids, System.Classes;

type
  TFrm_ControlCalidad = class(TForm)
    statInformacion: TStatusBar;
    grpOpciones: TGroupBox;
    spl1: TSplitter;
    grpImagen: TGroupBox;
    grpEncabezado: TGroupBox;
    imgImagenCalidad: TImageScrollBox;
    grpFolio: TGroupBox;
    btnNovedad: TButton;
    btnTestigo: TButton;
    btnFinalizar: TButton;
    grpBuscarCaja: TGroupBox;
    lblCaja: TLabel;
    edBuscarCaja: TEdit;
    grp3: TGroupBox;
    dbeCaja: TDBEdit;
    dbeCodigoCarpeta: TDBEdit;
    dbeDescripcionSubSerieDocumental: TDBEdit;
    lbl1: TLabel;
    lbl2: TLabel;
    lbl3: TLabel;
    dbtxtDescripcionSerieDocumental: TDBText;
    btnCambiarFolio: TButton;
    btnNuevo: TButton;
    btnCapturable: TButton;
    lblFolio: TLabel;
    edFolio: TEdit;
    lblFolios: TLabel;
    lblNoFolio: TLabel;
    edNoFolio: TEdit;
    RpnMensajeImagen: TRxPanel;
    rxlMensajeImagen: TRxLabel;
    lstDatosCarpeta: TValueListEditor;
    grpZoom: TGroupBox;
    lblZoom: TLabel;
    scrlbrZoom: TScrollBar;
    edtZoom: TEdit;
    btnDerecha: TSpeedButton;
    btnIzquierda: TSpeedButton;
    grp2: TGroupBox;
    btnIdentificacion: TButton;
    PnlEncabezado: TPanel;
    procedure edBuscarCajaKeyPress(Sender: TObject; var Key: Char);
    procedure btnTestigoClick(Sender: TObject);
    procedure btnIdentificacionClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure btnNuevoClick(Sender: TObject);
    procedure btnIzquierdaClick(Sender: TObject);
    procedure btnDerechaClick(Sender: TObject);
    procedure scrlbrZoomChange(Sender: TObject);
    procedure btnNovedadClick(Sender: TObject);
    procedure edtZoomKeyPress(Sender: TObject; var Key: Char);
    procedure btnCambiarFolioClick(Sender: TObject);
    procedure btnCapturableClick(Sender: TObject);
    procedure btnFinalizarClick(Sender: TObject);
    procedure edNoFolioKeyPress(Sender: TObject; var Key: Char);
    procedure FormCloseQuery(Sender: TObject; var CanClose: Boolean);
  private
    { Private declarations }
  public
    { Public declarations }
    FTP : TFtp;
    procedure ConfigurarAmbiente;
    procedure ConfigurarFTP;
    procedure ConfigurarDirectorios;
    function MostrarImagen (Ruta, RutaFTP, NombreImagen : string): boolean;
    procedure HabilitarBotones (Criterio : integer);
    procedure PublicarImagen (Ruta, NombreArchivo, RutaFTP, NombreImagen  : string);
    function TamanoArchivo (sFileToExamine: string) : Longword;
    Procedure VerificarVersion(p_NombModu: string;p_VersModu: string; p_VeriRuta: boolean);
    procedure InformacionCarpeta;
    procedure LimpiarFormulario (PathCalidad : string);
  end;

var

  Frm_ControlCalidad : TFrm_ControlCalidad;
  CarpImag     : TCliente;     {DATOS DE LAS CARPETAS PARA LAS IMAGENES}
  CantCarp     : Integer;      {CANTIDAD DE CARPETAS A PROCESAR}
  CantFoli     : Integer;      {CANTIDAD DE FOLIOS A PROCESAR}
  DireccIP     : String;
  FileName     : String;
  NombModu     : string;
  NoFolios     : integer;
  PosFolio     : integer;
  FolioBloqueo : integer;
  VersModu     : string;

implementation

{$R *.dfm}

function TFrm_ControlCalidad.TamanoArchivo (sFileToExamine: string) : Longword;
var
  FileHandle: THandle;
  FileSize: Longword;
  d1: Double;
begin
  FileHandle := CreateFile(PChar(sFileToExamine), GENERIC_READ,0, {exclusivo} nil, {seguridad}  OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL,  0);
  FileSize   := GetFileSize(FileHandle, nil);
  Result     := FileSize;
  CloseHandle(FileHandle);
end;

procedure TFrm_ControlCalidad.btnIzquierdaClick(Sender: TObject);
begin
  Dec(PosFolio);
  if PosFolio < 1 then
    PosFolio := 1;
  lblFolios.Caption := 'Folio '+ LlenarCerosIzquierda('4',PosFolio)+' de '+LlenarCerosIzquierda('4',NoFolios);
  DAOControlCalidad.cdsDatosFolio.Prior;
  edFolio.Text := DAOControlCalidad.cdsDatosFolio.FieldByName('CodigoFolio').AsString;
  DAOControlCalidad.AletaFolio(DAOControlCalidad.cdsDatosFolio.FieldByName('idFolio').AsInteger);
  MostrarImagen (ExtractFilePath(Application.ExeName)+'ImagenesCalidad\' ,
                      DAOControlCalidad.cdsDatosFolio.FieldByName('RutaFTP').AsString,
                      DAOControlCalidad.cdsDatosFolio.FieldByName('NombreImagen').AsString);
end;

procedure TFrm_ControlCalidad.btnCambiarFolioClick(Sender: TObject);
var
  ArchivoImagen : TSearchRec;
  iResultado    : integer;
  Directory     : TFileName;
  NombreArchivo : TFileName;
  Version       : integer;
  VersionImagen : string;
begin
  Directory  := 'C:\Digitalizacion\UNIANDES\CALIDAD\';
  Directory  := StringReplace(Directory, '\\', '\', [rfReplaceAll]);
  Directory  := IncludeTrailingBackslash(Directory);
  iResultado :=  FindFirst(Directory + '*.tif', faAnyFile, ArchivoImagen);
  if iResultado = 0 then
  begin
    if Application.MessageBox('¿Está seguro que desea cambiar la imagen seleccionada?','Información', MB_OKCANCEL + MB_ICONINFORMATION) = ID_OK then
    begin
      while (iResultado = 0) do
      begin
        if (ArchivoImagen.Attr and faArchive = faArchive) and (ArchivoImagen.Attr and faDirectory <> faDirectory) then
        begin
          Version       := DAOControlCalidad.cdsDatosFolio.FieldByName('Version').AsInteger + 1;
          VersionImagen := Copy (DAOControlCalidad.cdsDatosFolio.FieldByName('NombreImagen').AsString, 1, Length(DAOControlCalidad.cdsDatosFolio.FieldByName('NombreImagen').AsString)-6) + LlenarCerosIzquierda('2',Version)+'.tif';
          Directory := 'C:\Digitalizacion\UNIANDES\CALIDAD\' + ArchivoImagen.Name;
          NombreArchivo := 'C:\Digitalizacion\UNIANDES\CALIDAD\' + DAOControlCalidad.cdsDatosFolio.FieldByName('NombreImagen').AsString;
          RenameFile (Directory, NombreArchivo);

          PublicarImagen ('C:\Digitalizacion\UNIANDES\CALIDAD\', DAOControlCalidad.cdsDatosFolio.FieldByName('NombreImagen').AsString, DAOControlCalidad.cdsDatosFolio.FieldByName('RutaFTP').AsString,  VersionImagen);

          DAOControlCalidad.ActualizarPublicacion(DAOControlCalidad.cdsDatosFolio.FieldByName('idFolio').AsInteger, imgImagenCalidad.Graphic.XDotsPerInch, imgImagenCalidad.Graphic.YDotsPerInch, TamanoArchivo(NombreArchivo),
                                                  Version,  DAOControlCalidad.cdsDatosFolio.FieldByName('RutaFTP').AsString, FTP.IPServidor, DireccIP, VersionImagen);

          if NOT DeleteFile(ExtractFilePath(Application.ExeName)+'ImagenesCalidad\'+DAOControlCalidad.cdsDatosFolio.FieldByName('NombreImagen').AsString) then
            ShowMessage(fileName+' Error al borara la imagen original : '+ IntToStr(GetLastError));
          if NOT DeleteFile ('C:\Digitalizacion\UNIANDES\CALIDAD\'+DAOControlCalidad.cdsDatosFolio.FieldByName('NombreImagen').AsString) then
            ShowMessage(fileName+' Error al borara la imagen original : '+ IntToStr(GetLastError));
          {SE ACTUALIZA EL CLIENTDATASET CON LA NUEVA IMAGEN PARA QUE SE MUESTRE}
          DAOControlCalidad.cdsDatosFolio.Edit;
          DAOControlCalidad.cdsDatosFolio.FieldByName('NombreImagen').AsString  := VersionImagen;
          DAOControlCalidad.cdsDatosFolio.FieldByName('Version').AsInteger      := Version;
          if MostrarImagen (ExtractFilePath(Application.ExeName)+'ImagenesCalidad\' , DAOControlCalidad.cdsDatosFolio.FieldByName('RutaFTP').AsString,
                            DAOControlCalidad.cdsDatosFolio.FieldByName('NombreImagen').AsString) then
          begin
            if NOT DAOControlCalidad.cdsDatosFolio.FieldByName('ChequeoCalidad').AsBoolean then
              DAOControlCalidad.ChequeoCalidad(DAOControlCalidad.cdsDatosFolio.FieldByName('idFolio').AsInteger, True, 0);
            ShowMessage('La Imagen se reemplazó con éxito. ' + #13#10
                        + ' El nombre de la nueva imagen es: ['
                        + DAOControlCalidad.cdsDatosFolio.FieldByName('NombreImagen').AsString
                        + '].')
          end;
          break;
        end;
        iResultado := FindNext(ArchivoImagen);
      end;
    end;
  end
  else
    ShowMessage('En la Carpeta de Trabajo no existe el archivo de imagen por el cual se va a reemplazar.');

  btnNovedad.Caption := 'Novedad';
  HabilitarBotones(2);
end;

procedure TFrm_ControlCalidad.btnCapturableClick(Sender: TObject);
begin
  if btnCapturable.Caption = 'NO Capturable' then
    begin
      if Application.MessageBox ('Este proceso marca el folio como NO CAPTURABLE. ¿Desea Continuar? ','Información', MB_OKCANCEL + MB_ICONINFORMATION) = ID_OK then
        if DAOControlCalidad.MarcarCapturable(DAOControlCalidad.cdsDatosFolio.FieldByName('idFolio').AsInteger, 1) then
          ShowMessage('Se ha realizado el cambio de forma satisfactoria (Folio NO CAPTURABLE) ...');
  end else
     begin
       if Application.MessageBox ('Este proceso marca el folio como CAPTURABLE. ¿Desea Continuar? ','Información', MB_OKCANCEL + MB_ICONINFORMATION) = ID_OK then
         if DAOControlCalidad.MarcarCapturable(DAOControlCalidad.cdsDatosFolio.FieldByName('idFolio').AsInteger, 2) then
           ShowMessage('Se ha realizado el cambio de forma satisfactoria (Folio CAPTURABLE) ...');
     end;
end;

procedure TFrm_ControlCalidad.btnDerechaClick(Sender: TObject);
begin
  Inc(PosFolio);
  if PosFolio > NoFolios then
    PosFolio := NoFolios;
  lblFolios.Caption := 'Folio '+LlenarCerosIzquierda('4',PosFolio)+' de '+LlenarCerosIzquierda('4',NoFolios);
  {SE OCULTA MOMENTANEAMENTE EL BOTON PARA QUE NO LE DEN CLICK SEGUIDO Y PASE LAS IMÁGENES RAPIDO}
  btnDerecha.Visible:= False;
  Application.ProcessMessages;
  if NOT DAOControlCalidad.cdsDatosFolio.Eof then
    begin
      DAOControlCalidad.cdsDatosFolio.Next;
      edFolio.Text := DAOControlCalidad.cdsDatosFolio.FieldByName('CodigoFolio').AsString;
      DAOControlCalidad.AletaFolio(DAOControlCalidad.cdsDatosFolio.FieldByName('idFolio').AsInteger);
      if MostrarImagen (ExtractFilePath(Application.ExeName)+'ImagenesCalidad\' ,
                          DAOControlCalidad.cdsDatosFolio.FieldByName('RutaFTP').AsString,
                          DAOControlCalidad.cdsDatosFolio.FieldByName('NombreImagen').AsString)  then
        {SI SE PUDO  MOSTRAR LA IMAGEN SE CHEQUEA CALIDAD}
        DAOControlCalidad.ChequeoCalidad(DAOControlCalidad.cdsDatosFolio.FieldByName('idFolio').AsInteger, True, FolioBloqueo)
      else
        {SI NO SE PUDO  MOSTRAR LA IMAGEN SE DESCHEQUEA CALIDAD}
        DAOControlCalidad.ChequeoCalidad(DAOControlCalidad.cdsDatosFolio.FieldByName('idFolio').AsInteger, False, FolioBloqueo);
      FolioBloqueo := DAOControlCalidad.cdsDatosFolio.FieldByName('idFolio').AsInteger;
  end else
     ShowMessage('Fin de las imágenes de la carpeta ...');
  Application.ProcessMessages;
  Sleep(500);
  Application.ProcessMessages;
  {SE MUESTRA EL BOTON DESPUES DE ESPERAR UN SEGUNDO Y DE PROCESAR Y LIMPIAR LA COLA DE EVENTOS }
  btnDerecha.Visible:=True;

end;

procedure TFrm_ControlCalidad.btnFinalizarClick(Sender: TObject);
var
  PathCalidad : string;
begin
  PathCalidad := ExtractFilePath(Application.ExeName)+'ImagenesCalidad\';

  if Application.MessageBox ('¿Desea Finalizar esta Carpeta?','Información', MB_OKCANCEL + MB_ICONINFORMATION) = ID_OK then
    begin
      if DAOControlCalidad.ValidarFolios(DAOControlCalidad.dsCarpeta.DataSet.FieldByName('idCarpeta').AsInteger) then
        begin

          if DAOControlCalidad.CarpetaNoCapturable(DAOControlCalidad.dsCarpeta.DataSet.FieldByName('idCarpeta').AsInteger) then
            begin
            if Insercion then
              begin
               DAOControlCalidad.ReplicaData(DAOControlCalidad.dsCarpeta.DataSet.FieldByName('idCarpeta').AsInteger, ParamStr(1));
               DAOControlCalidad.CambiarEstado(DAOControlCalidad.dsCarpeta.DataSet.FieldByName('idCarpeta').AsInteger,2);
               ShowMessage('Operación terminada con éxito ...');
            end else
               begin
                 ShowMessage('Debe tener al menos un documento capturable para poder avanzar...');
                 Exit;
               end;
          end else
              begin
                DAOControlCalidad.ChequeoCalidad(DAOControlCalidad.cdsDatosFolio.FieldByName('idFolio').AsInteger, True, FolioBloqueo);
                DAOControlCalidad.CambiarEstado(DAOControlCalidad.dsCarpeta.DataSet.FieldByName('idCarpeta').AsInteger,1);
                ShowMessage('Operación terminada con éxito ...');
              end;
          LimpiarFormulario(PathCalidad);
      end else
         ShowMessage('No coincide el número de folios con los revisados en Calidad ...');
  end;
end;

procedure TFrm_ControlCalidad.btnIdentificacionClick(Sender: TObject);
begin
  if Application.MessageBox ('¿Está seguro que desea marcar este folio como identificación asociada a la carpeta?','Información', MB_OKCANCEL + MB_ICONINFORMATION) = ID_OK then
    begin
    if frm_Identificacion.ShowModal = mrOK then
      frm_Identificacion.Visible := True;
    ShowMessage('Cambio realizado con éxito ...');
  end;
end;

procedure TFrm_ControlCalidad.btnNovedadClick(Sender: TObject);
begin
  if btnNovedad.Caption = 'Novedad' then
    begin
      btnNovedad.Caption := 'Cancelar';
      HabilitarBotones(1);
  end else
     begin
       btnNovedad.Caption := 'Novedad';
       HabilitarBotones(2);
     end;
end;

procedure TFrm_ControlCalidad.btnNuevoClick(Sender: TObject);
begin
  FolioBloqueo := 0;
  NoFolios := DAOControlCalidad.DatosFolio(DAOControlCalidad.dsCarpeta.DataSet.FieldByName('idCarpeta').AsInteger);
  PosFolio := 1;
  lblFolios.Caption := 'Folio '+LlenarCerosIzquierda('4',PosFolio)+' de '+LlenarCerosIzquierda('4',NoFolios);
  DAOControlCalidad.cdsDatosFolio.First;
  edFolio.Text := DAOControlCalidad.cdsDatosFolio.FieldByName('CodigoFolio').AsString;
  FolioBloqueo := DAOControlCalidad.cdsDatosFolio.FieldByName('idFolio').AsInteger;
  DAOControlCalidad.AletaFolio(DAOControlCalidad.cdsDatosFolio.FieldByName('idFolio').AsInteger);
  if MostrarImagen (ExtractFilePath(Application.ExeName)+'ImagenesCalidad\' ,
                    DAOControlCalidad.cdsDatosFolio.FieldByName('RutaFTP').AsString,
                    DAOControlCalidad.cdsDatosFolio.FieldByName('NombreImagen').AsString) then
    {SI SE PUDO  MOSTRAR LA IMAGEN SE CHEQUEA CALIDAD}
    DAOControlCalidad.ChequeoCalidad(DAOControlCalidad.cdsDatosFolio.FieldByName('idFolio').AsInteger, True, FolioBloqueo)
  else
    {SI NO SE PUDO  MOSTRAR LA IMAGEN SE DESCHEQUEA CALIDAD}
    DAOControlCalidad.ChequeoCalidad(DAOControlCalidad.cdsDatosFolio.FieldByName('idFolio').AsInteger, False, FolioBloqueo);
end;

procedure TFrm_ControlCalidad.btnTestigoClick(Sender: TObject);
begin
  if frm_Testigo.ShowModal = mrOk then
    frm_Testigo.Visible := True;
end;

procedure TFrm_ControlCalidad.ConfigurarAmbiente;
begin
  NombModu:= 'MODULOCONTROLCALIDAD';
  VersModu:= '20170606.M01';

  {SE VERIFICA LA LA VERSION DEL MÓDULO)}
  VerificarVersion(NombModu, VersModu, VeriRuta);
  Frm_ControlCalidad.Caption:= 'Control Calidad - [ Versión ' + VersModu + ' ]';
  with TIdIPWatch.Create() do
  begin
    DireccIP  := LocalIP;
    Free;
  end;
  statInformacion.Panels[0].Text :='Usuario: ' + ParamStr(1) + ' - ' + ParamStr(2) ;
  statInformacion.Panels[1].Text :='IP: ' + DireccIP;

  if DMConexion.Ambiente <> 'PRODUCCIÓN' then
  begin
    if DMConexion.Ambiente = 'DESARROLLO' then
      pnlEncabezado.Font.Color   := clPurple
    else
      if DMConexion.Ambiente = 'PRUEBAS' then
        pnlEncabezado.Font.Color   := clMaroon;
    pnlEncabezado.Caption := pnlEncabezado.Caption + '   [' + DMConexion.Ambiente + ']';
  end;

end;


procedure TFrm_ControlCalidad.ConfigurarDirectorios;
begin
  try //Directorios a validar
    CarpImag := TCliente.create;
    CarpImag.ConfigurarCliente;
    if not DirectoryExists(CarpImag.RutaScanner) then
      ForceDirectories(CarpImag.RutaScanner);
    if not DirectoryExists(CarpImag.RutaNovedad) then
      ForceDirectories(CarpImag.RutaNovedad);
    if not DirectoryExists(CarpImag.RutaProceso) then
      ForceDirectories(CarpImag.RutaProceso);
    if not DirectoryExists(CarpImag.RutaPublicado) then
      ForceDirectories(CarpImag.RutaPublicado);
    if not DirectoryExists(CarpImag.RutaCalidad) then
      ForceDirectories(CarpImag.RutaCalidad);
    if not DirectoryExists(ExtractFilePath(Application.ExeName)+'ImagenesCalidad') then
      ForceDirectories(ExtractFilePath(Application.ExeName)+'ImagenesCalidad');
  except
    on e:exception do
      begin
        Application.MessageBox(PChar(e.Message), 'Publicación de Imágenes',MB_OK OR MB_ICONERROR);
        Application.Terminate;
    end;
  end;
end;

procedure TFrm_ControlCalidad.ConfigurarFTP;
begin
  try
    FTP  := TFTP.Create;
    FTP.ConfigurarFTP;
    if not FTP.TestConexion then
      begin
        Application.MessageBox('Error, no se estableció conexión con el FTP. Favor Verificar. ', 'Publicación de Imágenes',MB_OK OR MB_ICONERROR);
        Application.Terminate;
    end;
  except
    on e:exception do
      begin
        Application.MessageBox(PChar(e.Message), 'Control Calidad de Imágenes',MB_OK OR MB_ICONERROR);
        Application.Terminate;
    end;
  end;
end;


procedure TFrm_ControlCalidad.edBuscarCajaKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
    if DAOControlCalidad.BuscarCaja(edBuscarCaja.Text) then
    begin
      grpFolio.Enabled := True;
      lstDatosCarpeta.Enabled := True;
      DAOControlCalidad.dsCarpeta.DataSet.First;
      if DAOControlCalidad.cdsCarpeta.FieldByName('DescripcionTipoSerieDocumental').AsString = 'HISTORIAS LABORALES' then
      begin
        btnCapturable.Caption := 'Capturable';
        DAOControlCalidad.MarcarNoCapturable(DAOControlCalidad.dsCarpeta.DataSet.FieldByName('idCarpeta').AsInteger);
      end;
      if DAOControlCalidad.cdsCarpeta.FieldByName('ClaseCarpeta').AsString = 'I' then
        if Application.MessageBox ('Los folios a procesar son de tipo Inserción. ¿Desea continuar?','Información', MB_OKCANCEL + MB_ICONINFORMATION) = ID_OK then
          begin
            DAOControlCalidad.DatosCarpeta(DAOControlCalidad.cdsCarpeta.FieldByName('idCarpetaCrea').AsInteger);
            InformacionCarpeta;
        end else
           Exit;

      grpFolio.Enabled := True;
    end
    else
       ShowMessage('No se encontró la Carpeta o no esta disponible para este módulo ...');
end;

procedure TFrm_ControlCalidad.edNoFolioKeyPress(Sender: TObject; var Key: Char);
var
   i : integer;
begin
  if Key = #13 then
    begin
      if edNoFolio.Text = '' then
        edNoFolio.Text := '1';
      NoFolios := DAOControlCalidad.DatosFolio(DAOControlCalidad.dsCarpeta.DataSet.FieldByName('idCarpeta').AsInteger);
      PosFolio := 0;
      DAOControlCalidad.cdsDatosFolio.First;
      for i := 1 to StrToInt(edNoFolio.Text) do
         begin
           DAOControlCalidad.cdsDatosFolio.Next;
           Inc(PosFolio);
      end;
      lblFolios.Caption := 'Folio '+LlenarCerosIzquierda('4',PosFolio)+' de '+LlenarCerosIzquierda('4',NoFolios);
      edFolio.Text := DAOControlCalidad.cdsDatosFolio.FieldByName('CodigoFolio').AsString;
      if MostrarImagen (ExtractFilePath(Application.ExeName)+'ImagenesCalidad\' ,
                        DAOControlCalidad.cdsDatosFolio.FieldByName('RutaFTP').AsString,
                        DAOControlCalidad.cdsDatosFolio.FieldByName('NombreImagen').AsString) then
        {SI SE PUDO  MOSTRAR LA IMAGEN SE CHEQUEA CALIDAD}
        DAOControlCalidad.ChequeoCalidad(DAOControlCalidad.cdsDatosFolio.FieldByName('idFolio').AsInteger, True, FolioBloqueo)
      else
        {SI NO SE PUDO  MOSTRAR LA IMAGEN SE DESCHEQUEA CALIDAD}
        DAOControlCalidad.ChequeoCalidad(DAOControlCalidad.cdsDatosFolio.FieldByName('idFolio').AsInteger, False, FolioBloqueo);
      FolioBloqueo := DAOControlCalidad.cdsDatosFolio.FieldByName('idFolio').AsInteger;
  end;
end;


procedure TFrm_ControlCalidad.edtZoomKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
    begin
    imgImagenCalidad.ZoomPercent := StrToInt(edtZoom.Text);
    scrlbrZoom.Position := StrToInt(edtZoom.Text);
  end;
end;

procedure TFrm_ControlCalidad.FormCloseQuery(Sender: TObject; var CanClose: Boolean);
var
  PathCalidad : string;
begin
  PathCalidad := ExtractFilePath(Application.ExeName)+'ImagenesCalidad\';
  if TDirectory.Exists(PathCalidad, True) then
    TDirectory.Delete(PathCalidad, True);
end;


procedure TFrm_ControlCalidad.FormShow(Sender: TObject);
begin
  ConfigurarAmbiente;
  ConfigurarFtp;
  ConfigurarDirectorios;
  scrlbrZoom.Position := 100;
end;

procedure TFrm_ControlCalidad.HabilitarBotones(Criterio: integer);
begin
  case Criterio of
           1 : begin
                 btnTestigo.Enabled := False;
                 btnFinalizar.Enabled := False;
                 btnIdentificacion.Enabled := False;
                 btnDerecha.Enabled := False;
                 btnIzquierda.Enabled := False;
                 btnCambiarFolio.Visible := True;
                 btnNuevo.Visible := False;
               end;
           2 : begin
                 btnTestigo.Enabled := True;
                 btnFinalizar.Enabled := True;
                 btnIdentificacion.Enabled := True;
                 btnDerecha.Enabled := True;
                 btnIzquierda.Enabled := True;
                 btnCambiarFolio.Visible := False;
                 btnNuevo.Visible := True;
               end;
  end;
end;

procedure TFrm_ControlCalidad.InformacionCarpeta; //Llenar la información del lstDatosCarpeta para datos básicos capturados en la carpeta origen
var
  i : Integer;
begin
  if DAOControlCalidad.cdsDatosCarpeta.FieldByName('NumeroDocumento').AsString <> '' then
    begin
      DAOControlCalidad.cdsDatosCarpeta.First;
      lstDatosCarpeta.Values['Nombres y Apellidos'] := DAOControlCalidad.cdsDatosCarpeta.FieldByName('NombresApellidos').AsString;
      repeat
        for i := 0 to 2 do
           case i of
                0 : begin
                      if DAOControlCalidad.cdsDatosCarpeta.FieldByName('idTipoIdentificacion').AsInteger = 1 then
                        lstDatosCarpeta.Values['Cédula de Ciudadanía'] := DAOControlCalidad.cdsDatosCarpeta.FieldByName('NumeroDocumento').AsString;
                    end;
                1 : begin
                      if DAOControlCalidad.cdsDatosCarpeta.FieldByName('idTipoIdentificacion').AsInteger = 2 then
                        lstDatosCarpeta.Values['Cédula de Extranjería'] := DAOControlCalidad.cdsDatosCarpeta.FieldByName('NumeroDocumento').AsString;
                    end;
                2 : begin
                      if DAOControlCalidad.cdsDatosCarpeta.FieldByName('idTipoIdentificacion').AsInteger = 8 then
                        lstDatosCarpeta.Values['Pasaporte'] := DAOControlCalidad.cdsDatosCarpeta.FieldByName('NumeroDocumento').AsString;
                    end;
           end;
         DAOControlCalidad.cdsDatosCarpeta.Next;
      until DAOControlCalidad.cdsDatosCarpeta.Eof;
  end;
end;

procedure TFrm_ControlCalidad.LimpiarFormulario (PathCalidad : string);
begin
  if TDirectory.Exists(PathCalidad, True) then
    TDirectory.Delete(PathCalidad, True);

  RemoveDir(ExtractFilePath(Application.ExeName)+'ImagenesCalidad\');
  edBuscarCaja.Text := '';
  grpFolio.Enabled := False;
  dbtxtDescripcionSerieDocumental.Caption := '';
  edFolio.Text := '';
  dbeCaja.Text := '';
  dbeCodigoCarpeta.Text := '';
  dbeDescripcionSubSerieDocumental.Text := '';
  edBuscarCaja.SetFocus;
  lstDatosCarpeta.Values['Cédula de Ciudadanía'] := '';
  lstDatosCarpeta.Values['Cédula de Ciudadanía'] := '';
  lstDatosCarpeta.Values['Cédula de Extranjería'] := '';
  lstDatosCarpeta.Values['Pasaporte'] := '';
  lstDatosCarpeta.Values['Nombres y Apellidos'] := '';
  lstDatosCarpeta.Enabled := False;
  imgImagenCalidad.Clear;
  ConfigurarFtp;
  ConfigurarDirectorios;
  scrlbrZoom.Position := 100;
end;

function TFrm_ControlCalidad.MostrarImagen (Ruta, RutaFTP, NombreImagen : string):boolean;
var
  MensErro: string;
begin
  result := true;
  RpnMensajeImagen.Visible:= False;
  if FileExists(Ruta+NombreImagen) then
  begin
      {MOSTRAR IMAGEN}
      if AnsiCompareStr(imgImagenCalidad.FileName, Ruta) <> 0 then
        begin
          FileName := Ruta+NombreImagen;
          imgImagenCalidad.AntiAliased := False;
          imgImagenCalidad.LoadFromFile(FileName, 1);
          imgImagenCalidad.ZoomMode := zmFitWidth;
          //imgImagenCalidad.ZoomPercent := scrlbrZoom.Position;
          imgImagenCalidad.MouseMode := mmAnnotate;
      end;
  end
  else
  begin
   {TRAER IMAGEN}
    try
      FTP.ConectarFTP;
      FTP.BajarArchivo(RutaFTP, NombreImagen, Ruta);
      FTP.DesconectarFTP;
    except
      MensErro:= 'NO ES POSIBLE DESCARGAR LA IMAGEN' + #13#10
                  + '[' + NombreImagen + ']' + #13#10 + #13#10
                  + 'RAZONES POSIBLES:                                  '
                  + #13#10
                  + '* LA IMAGEN NO EXISTE EN EL SERVIDOR.              '
                  + #13#10
                  + '* HAY UNA FALLA EN LA COMUNICACION CON EL SERVIDOR.'
                  + #13#10 + #13#10
                  + 'Favor intente cargar nuevamene la Imagen. '
                   + #13#10
                  + 'Si la falla continua, Reemplace la Imagen por la opción NOVEDAD.';
      Result:= false;
    end;
    if result then
    begin
      try
        FileName := Ruta+NombreImagen;
        imgImagenCalidad.AntiAliased := False;
        imgImagenCalidad.LoadFromFile(FileName, 1);
        imgImagenCalidad.ZoomMode := zmFitWidth;
        //imgImagenCalidad.ZoomPercent := scrlbrZoom.Position;
        imgImagenCalidad.MouseMode := mmAnnotate;
      except
        MensErro:= 'NO ES POSIBLE MOSTRAR LA IMAGEN' + #13#10
                    + '[' + NombreImagen + ']' + #13#10 + #13#10
                    + 'PARAMETROS DE DIGITALIZACIÓN INCORRECTOS.'
                    + #13#10 + #13#10
                    + 'Favor Reemplace la Imagen por la opción NOVEDAD.';
        Result:= false;
      end;
    end;
    if not result then
    begin
      imgImagenCalidad.clear;
      rxlMensajeImagen.Caption:= MensErro;
      RpnMensajeImagen.Visible:= True;
    end;
  end;
end;

procedure TFrm_ControlCalidad.PublicarImagen (Ruta, NombreArchivo, RutaFTP, NombreImagen  : string);
begin
  FTP.ConectarFTP;
  FTP.SubirArchivo(Ruta, NombreArchivo, RutaFTP, NombreImagen);
end;

Procedure TFrm_ControlCalidad.VerificarVersion(p_NombModu: string;p_VersModu: string; p_VeriRuta:Boolean);
begin
  DMAplicacion.VerificarAplicacion(p_NombModu,p_VersModu, 'CONTROL CALIDAD', p_VeriRuta);
end;

procedure TFrm_ControlCalidad.scrlbrZoomChange(Sender: TObject);
begin
  imgImagenCalidad.ZoomPercent := scrlbrZoom.Position;
  edtZoom.Text := IntToStr(scrlbrZoom.Position);
end;

end.
